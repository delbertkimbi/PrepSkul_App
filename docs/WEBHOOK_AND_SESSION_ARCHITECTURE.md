# Webhook & Session Architecture - Complete Guide

## ğŸ“ Question 1: Where are the Webhooks?

### âœ… **Answer: Webhooks are in the Next.js Web App (NOT in Flutter App)**

**Location:**
- **Fapshi Webhook:** `PrepSkul_Web/app/api/webhooks/fapshi/route.ts`
- **Fathom Webhook:** `PrepSkul_Web/app/api/webhooks/fathom/route.ts`

**Why Web App (Not Flutter App)?**
1. âœ… **Always Available** - Web servers are always running, mobile apps are not
2. âœ… **Reliable** - Webhooks need a stable, public URL
3. âœ… **Security** - Server-side processing is more secure
4. âœ… **Scalability** - Can handle multiple webhook events simultaneously
5. âœ… **No App Dependency** - Works even if user's phone is off

**How It Works:**
```
Fapshi/Fathom â†’ Webhook URL â†’ Next.js API Route â†’ Updates Supabase â†’ Flutter App (via real-time subscriptions)
```

**Webhook URLs:**
- **Production:** `https://app.prepskul.com/api/webhooks/fapshi`
- **Production:** `https://app.prepskul.com/api/webhooks/fathom`
- **Development:** Use ngrok or similar for local testing

---

## ğŸ“ Question 2: Google Meet Integration & Session Location

### âœ… **Answer: Yes, we use Google Calendar API. Sessions are OUTSIDE the app.**

### **Google Meet Link Generation:**

**How It Works:**
1. **We use Google Calendar API** (not a separate Meet API)
2. When creating a calendar event, we request a Meet link
3. Google Calendar automatically generates the Meet link
4. The Meet link is stored in our database

**Implementation:**
- **Service:** `lib/core/services/google_calendar_service.dart`
- **Method:** `createSessionEvent()` - Creates calendar event with Meet link
- **API:** Google Calendar API v3 with `conferenceDataVersion: 1`

**Code Flow:**
```dart
// 1. Create calendar event with Meet link request
final calendarEvent = await GoogleCalendarService.createSessionEvent(
  title: 'Trial Session: Math',
  startTime: scheduledTime,
  durationMinutes: 60,
  attendeeEmails: [tutorEmail, studentEmail, prepskulVAEmail],
);

// 2. Meet link is automatically generated by Google Calendar
// 3. Store Meet link in database
await supabase.from('trial_sessions').update({
  'meet_link': calendarEvent.meetLink,
});
```

### **Where Sessions Are Held:**

**âœ… Sessions are OUTSIDE the app - They're Google Meet links**

**How Users Join:**
1. **Mobile App:** Opens Meet link â†’ Redirects to Google Meet app or browser
2. **Web App:** Opens Meet link â†’ Opens in new tab/window
3. **Desktop:** Opens Meet link â†’ Opens in browser or Meet desktop app

**Session Flow:**
```
User taps "Join Session" in app
  â†“
App opens Meet link (stored in database)
  â†“
Google Meet opens (in app/browser)
  â†“
Session happens in Google Meet (outside our app)
  â†“
Fathom joins automatically (via calendar invite)
  â†“
After session, Fathom sends webhook with summary
```

**Important Notes:**
- âŒ **We DON'T host sessions** - Google Meet hosts them
- âŒ **We DON'T have video/audio in our app** - We just provide the link
- âœ… **Sessions work on any device** - Phone, tablet, computer
- âœ… **No app installation needed** - Works in browser too

---

## ğŸ“ Question 3: Calendar & Fathom Auto-Join

### âœ… **Answer: Yes, Fathom joins through calendar integration**

### **How Fathom Auto-Join Works:**

**Step-by-Step Process:**

1. **Create Calendar Event** (in our app)
   ```dart
   // When creating session, we add PrepSkul VA as attendee
   final attendees = [
     tutorEmail,
     studentEmail,
     'prepskul-va@prepskul.com'  // â† PrepSkul Virtual Assistant
   ];
   ```

2. **Fathom Monitors Calendar**
   - Fathom account is connected to `prepskul-va@prepskul.com` calendar
   - Fathom continuously monitors this calendar for new events
   - When it sees a calendar event with a Meet link, it prepares to join

3. **Fathom Auto-Joins**
   - When meeting time arrives, Fathom automatically joins
   - Fathom appears as a participant in the meeting
   - Fathom starts recording and transcribing

4. **After Meeting**
   - Fathom generates summary, transcript, and action items
   - Fathom sends webhook: `new_meeting_content_ready`
   - Our webhook handler processes the data

**Setup Required:**

1. **PrepSkul VA Email Account:**
   - Email: `prepskul-va@prepskul.com` (or similar)
   - This is a Gmail/Google Workspace account
   - Used ONLY for calendar invites (not for communication)

2. **Fathom Account Setup:**
   - Create Fathom account
   - Connect Fathom to PrepSkul VA's Google Calendar (OAuth)
   - Fathom will monitor this calendar

3. **Calendar Event Creation:**
   - When we create a session, we MUST add `prepskul-va@prepskul.com` as attendee
   - This is done automatically in `GoogleCalendarService.createSessionEvent()`

**Code Implementation:**

```dart
// In google_calendar_service.dart
final prepskulVAEmail = 'prepskul-va@prepskul.com';

// Ensure PrepSkul VA is in attendees
final allAttendees = <String>[...attendeeEmails];
if (!allAttendees.contains(prepskulVAEmail)) {
  allAttendees.add(prepskulVAEmail);  // â† Adds VA for Fathom
}

// Create event with all attendees
final event = cal.Event()
  ..attendees = allAttendees.map((email) => 
    cal.EventAttendee()..email = email
  ).toList();
```

**Fathom Webhook Handler:**

```typescript
// PrepSkul_Web/app/api/webhooks/fathom/route.ts
export async function POST(request: Request) {
  const { event, recording_id, calendar_invitees } = await request.json();
  
  if (event === 'new_meeting_content_ready') {
    // Fathom has finished processing the meeting
    // Fetch summary, transcript, action items
    // Store in database
    // Send notifications to tutor and student
  }
}
```

---

## ğŸ“Š Complete Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUTTER APP (Mobile)                      â”‚
â”‚  - User books session                                        â”‚
â”‚  - Initiates payment                                         â”‚
â”‚  - Views Meet link                                           â”‚
â”‚  - Joins session (opens Google Meet)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Creates session in Supabase
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE DATABASE                         â”‚
â”‚  - Stores session data                                       â”‚
â”‚  - Stores Meet link                                          â”‚
â”‚  - Stores payment status                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Webhook events
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
        â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FAPSHI WEBHOOK  â”‚        â”‚  FATHOM WEBHOOK   â”‚
â”‚  (Next.js API)   â”‚        â”‚  (Next.js API)    â”‚
â”‚                  â”‚        â”‚                   â”‚
â”‚  - Payment statusâ”‚        â”‚  - Meeting ready  â”‚
â”‚  - Updates DB    â”‚        â”‚  - Summary ready  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚
        â”‚                             â”‚
        â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GOOGLE CALENDAR API                            â”‚
â”‚  - Creates calendar event                                   â”‚
â”‚  - Generates Meet link                                      â”‚
â”‚  - Adds attendees (tutor, student, prepskul-va)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Calendar invite sent
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FATHOM AI                                      â”‚
â”‚  - Monitors prepskul-va@prepskul.com calendar              â”‚
â”‚  - Auto-joins when meeting starts                           â”‚
â”‚  - Records and transcribes                                  â”‚
â”‚  - Generates summary                                        â”‚
â”‚  - Sends webhook when ready                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Session happens here
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GOOGLE MEET (External)                         â”‚
â”‚  - Hosts the actual video call                              â”‚
â”‚  - Tutor joins                                              â”‚
â”‚  - Student joins                                            â”‚
â”‚  - Fathom joins (as participant)                            â”‚
â”‚  - Recording happens                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Summary

| Question | Answer |
|----------|--------|
| **Webhooks Location** | âœ… **Next.js Web App** (`PrepSkul_Web/app/api/webhooks/`) |
| **Google Meet API** | âœ… **Yes, using Google Calendar API** to generate Meet links |
| **Session Location** | âœ… **Outside app** - Sessions happen in Google Meet (external) |
| **Fathom Auto-Join** | âœ… **Yes, through calendar** - Fathom monitors PrepSkul VA calendar |
| **Calendar Integration** | âœ… **Yes** - We create calendar events with PrepSkul VA as attendee |

---

## ğŸ”§ Configuration Checklist

### For Fapshi Webhooks:
- [ ] Deploy Next.js app to production
- [ ] Configure webhook URL in Fapshi dashboard: `https://app.prepskul.com/api/webhooks/fapshi`
- [ ] Test with sandbox payments

### For Fathom Webhooks:
- [ ] Deploy Next.js app to production
- [ ] Configure webhook URL in Fathom dashboard: `https://app.prepskul.com/api/webhooks/fathom`
- [ ] Create PrepSkul VA email: `prepskul-va@prepskul.com`
- [ ] Connect Fathom to PrepSkul VA's Google Calendar
- [ ] Test with a sample meeting

### For Google Meet:
- [ ] Set up Google Cloud Project
- [ ] Enable Google Calendar API
- [ ] Configure OAuth credentials
- [ ] Test Meet link generation

---

**All webhooks are server-side (Next.js), sessions are external (Google Meet), and Fathom joins automatically via calendar!** âœ…

